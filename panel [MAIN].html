<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>XC Master Console - Pro</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

  <style>
    :root {
      --bg-body: #09090b;
      --bg-sidebar: #121217;
      --bg-card: #1c1c22;
      --bg-input: #27272a;
      
      --text-main: #f4f4f5;
      --text-muted: #a1a1aa;
      
      --accent: #6366f1; /* Indigo */
      --accent-hover: #4f46e5;
      
      --success: #22c55e;
      --warning: #eab308;
      --danger: #ef4444;
      
      --border: #2e2e36;
      --radius: 8px;
      --shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; outline: none; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-body);
      color: var(--text-main);
      display: flex;
      height: 100vh;
      overflow: hidden;
      font-size: 14px;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 8px;
      z-index: 50;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .brand {
      font-size: 18px;
      font-weight: 700;
      color: white;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding-left: 10px;
    }
    .brand i { color: var(--accent); font-size: 20px; }

    .nav-item {
      padding: 12px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      color: var(--text-muted);
      font-weight: 500;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .nav-item:hover { background: var(--bg-input); color: white; }
    .nav-item.active { background: var(--accent); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
    .nav-item i { width: 20px; text-align: center; }

    .connection-status {
      margin-top: auto;
      padding: 12px;
      background: var(--bg-input);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
    }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); box-shadow: 0 0 8px currentColor; }
    
    .status-live .status-dot { background: var(--success); color: var(--success); }
    .status-live .status-text { color: var(--success); font-weight: 600; }
    .status-offline .status-dot { background: var(--warning); color: var(--warning); }
    .status-offline .status-text { color: var(--warning); font-weight: 600; }

    /* --- MAIN CONTENT --- */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; width: 100%; }

    .topbar {
      height: 64px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-sidebar);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      flex-shrink: 0;
    }
    
    .menu-toggle { display: none; font-size: 20px; cursor: pointer; color: var(--text-main); margin-right: 15px; }

    h2 { font-size: 18px; font-weight: 600; white-space: nowrap; }

    /* Buttons & Inputs */
    .btn {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-main);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: 0.2s;
      display: inline-flex; align-items: center; gap: 8px;
      white-space: nowrap;
    }
    .btn:hover { border-color: var(--text-muted); }
    .btn-sm { padding: 4px 10px; font-size: 11px; }
    .btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); }
    
    .btn-danger { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); color: var(--danger); }
    .btn-danger:hover { background: var(--danger); color: white; }

    input, select, textarea {
      background: var(--bg-body);
      border: 1px solid var(--border);
      color: white;
      padding: 10px;
      border-radius: 6px;
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      transition: border 0.2s;
    }
    input:focus { border-color: var(--accent); }

    /* Content Layout */
    .content-area { flex: 1; overflow-y: auto; padding: 30px; position: relative; }
    .section { display: none; animation: fadeIn 0.3s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-header h3 { font-size: 16px; font-weight: 600; color: white; margin: 0; display: flex; align-items: center; gap: 8px; }

    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 12px; font-weight: 500; color: var(--text-muted); margin-bottom: 6px; }
    .form-row { display: flex; gap: 10px; }

    /* User Manager Specifics */
    .user-list-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
    }
    .user-list-item:hover { background: var(--bg-input); }
    .user-list-item.selected { background: rgba(99, 102, 241, 0.1); border-left: 3px solid var(--accent); }
    
    .badge { padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .badge-gray { background: var(--bg-input); color: var(--text-muted); }
    .badge-green { background: rgba(34, 197, 94, 0.15); color: var(--success); }
    .badge-blue { background: rgba(99, 102, 241, 0.15); color: var(--accent); }
    .badge-warn { background: rgba(234, 179, 8, 0.15); color: var(--warning); }

    /* Holding Item */
    .holding-item {
        display: flex; justify-content: space-between; align-items: center;
        background: var(--bg-body); border: 1px solid var(--border);
        padding: 10px; border-radius: 6px; margin-bottom: 10px;
    }
    .holding-item.has-balance { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }
    .holding-label { font-weight: 600; font-size: 13px; color: var(--text-muted); width: 60px; }
    .holding-item.has-balance .holding-label { color: var(--success); }

    /* Dynamic Row Styles (For Rules) */
    .dynamic-row {
        display: grid;
        grid-template-columns: 1fr 1fr 40px;
        gap: 8px;
        margin-bottom: 10px;
        align-items: center;
    }
    .dynamic-list-container {
        max-height: 250px;
        overflow-y: auto;
        padding-right: 5px;
        margin-bottom: 15px;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 10px;
        background: var(--bg-body);
    }
    .section-divider {
        margin: 20px 0;
        border: 0;
        border-top: 1px solid var(--border);
    }

    /* Table */
    .table-responsive { overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg-input); color: var(--text-muted); font-weight: 600; white-space: nowrap; }
    td { color: var(--text-main); }
    tr:hover td { background: var(--bg-input); }

    /* Staking Specifics */
    .coin-val { font-weight: 600; color: white; display: block; }
    .usd-val { font-size: 0.75rem; color: var(--success); font-weight: 500; display: block; margin-top: 2px; }
    .usd-val.dim { color: var(--text-muted); }

    /* Loading Overlay */
    #loadingOverlay {
        position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(9, 9, 11, 0.9);
        display: flex; justify-content: center; align-items: center;
        z-index: 1000; backdrop-filter: blur(4px);
    }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--bg-input); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Mobile Backdrop */
    .backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 40; display: none;
        backdrop-filter: blur(2px);
    }
    .backdrop.active { display: block; }

    /* Modal (Staking) */
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 100; }
    .modal.show { display: flex; }
    .modal-box { background: var(--bg-card); width: 600px; max-width: 95%; padding: 25px; border-radius: 12px; border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow); }
    
    .override-box { background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); padding: 15px; border-radius: 8px; margin: 15px 0; }
    .override-input { border-color: var(--success); font-weight: bold; font-size: 1.1rem; }
    
    .calc-preview { background: var(--bg-body); padding: 15px; border-radius: 6px; margin-top: 15px; font-size: 0.85rem; border: 1px solid var(--border); }

    /* --- RESPONSIVE MEDIA QUERIES --- */
    @media (max-width: 900px) {
        .sidebar {
            position: fixed; left: -280px; top: 0; height: 100%;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
        }
        .sidebar.active { transform: translateX(280px); }
        .menu-toggle { display: block; }
        .topbar { padding: 0 20px; }
        .content-area { padding: 20px; }
        
        .grid-2 { grid-template-columns: 1fr; } 
        #users .grid-2 { display: flex; flex-direction: column; height: auto; }
        #userListContainer { max-height: 300px; min-height: 300px; }
        .grid-3 { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
        .topbar { padding: 0 15px; }
        h2 { font-size: 16px; }
        .btn span { display: none; } 
        .card { padding: 15px; }
        .top-actions { display: none; }
    }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div style="text-align:center;">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:600;">Connecting...</p>
    </div>
  </div>

  <div class="backdrop" id="backdrop" onclick="toggleSidebar()"></div>

  <div class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fa-solid fa-layer-group"></i>
      <span>XC Console</span>
    </div>
    
    <div class="nav-item active" onclick="showSection('dashboard', this)">
      <i class="fa-solid fa-chart-line"></i> Dashboard
    </div>
    <div class="nav-item" onclick="showSection('stakeData', this)">
      <i class="fa-solid fa-coins"></i> Stake Data
    </div>
    <div class="nav-item" onclick="showSection('users', this)">
      <i class="fa-solid fa-users"></i> User Manager
    </div>
    <div class="nav-item" onclick="showSection('wallet', this)">
      <i class="fa-brands fa-bitcoin"></i> Market & Coin
    </div>
    <div class="nav-item" onclick="showSection('addressPool', this)">
        <i class="fa-solid fa-database"></i> Address Pool
    </div>
    <div class="nav-item" onclick="showSection('settings', this)">
      <i class="fa-solid fa-gears"></i> App Settings
    </div>

    <div class="connection-status status-offline" id="connStatus">
        <div class="status-dot"></div>
        <div class="status-text" id="connText">Disconnected</div>
    </div>
  </div>

  <div class="main">
    <div class="topbar">
        <div style="display:flex; align-items:center;">
            <i class="fa-solid fa-bars menu-toggle" onclick="toggleSidebar()"></i>
            <h2 id="pageTitle">Dashboard</h2>
        </div>
        <div style="display:flex; gap:8px;">
            <label class="btn">
                <i class="fa-solid fa-upload"></i> <span class="hide-mobile">JSON</span>
                <input type="file" id="jsonInput" style="display:none;" accept=".json" onchange="handleJsonUpload(this)">
            </label>
            <button class="btn btn-primary" onclick="exportData()">
                <i class="fa-solid fa-download"></i> <span class="hide-mobile">Backup</span>
            </button>
        </div>
    </div>

    <div class="content-area">
        
        <div id="dashboard" class="section active">
            <div class="grid-3">
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-user-group"></i> Total Users</h3></div>
                    <h1 id="stat-users">0</h1>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-wallet"></i> Address Pool</h3></div>
                    <h1 id="stat-pool">0</h1>
                    <small style="color:var(--text-muted)">Addresses Generated</small>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-arrow-trend-up"></i> Market Trend</h3></div>
                    <h1 id="stat-change" style="color:var(--success)">0%</h1>
                </div>
            </div>
        </div>

        <div id="stakeData" class="section">
            <div class="grid-3" style="margin-bottom:25px;">
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-sack-dollar"></i> TVL (USD)</h3></div>
                    <h1 id="stake-tvl">$0.00</h1>
                    <small style="color:var(--text-muted)">Total Value Locked</small>
                </div>
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-clock"></i> Reward Cycle</h3></div>
                    <h1 id="stake-cycle">...</h1>
                    <input type="number" id="globalPeriodMs" placeholder="86400000" style="margin-top:5px; display:none;">
                    <button class="btn btn-sm btn-primary" style="margin-top:5px;" onclick="promptCycleUpdate()">Edit Cycle</button>
                </div>
                <div class="card" style="justify-content:center; align-items:start; display:flex;">
                    <button class="btn btn-primary" style="width:100%; height:50px; font-size:1.1rem;" onclick="openAddModal()">
                        <i class="fa-solid fa-plus-circle"></i> Create New Stake
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3><i class="fa-solid fa-list-ul"></i> Active Stakes Database</h3>
                    <input type="text" id="stakeSearch" placeholder="Search UID or Asset..." style="width:250px; margin:0;" onkeyup="renderStakingSection()">
                </div>
                
                <div class="table-responsive">
                    <table id="stakesTable">
                        <thead>
                            <tr>
                                <th width="20%">User (UID)</th>
                                <th width="15%">Locked Asset</th>
                                <th width="15%">Total Earned</th>
                                <th width="15%">Available</th>
                                <th width="10%">Status</th>
                                <th width="10%">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stakesTableBody">
                            <tr><td colspan="6" style="text-align:center; padding:30px;">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="users" class="section">
            <div class="grid-2">
                <div class="card" style="display:flex; flex-direction:column; padding:0; overflow:hidden; max-height: 500px;">
                    <div style="padding:15px; border-bottom:1px solid var(--border);">
                        <input type="text" id="userSearch" placeholder="Search Email, Name or UID..." onkeyup="renderUserList()">
                    </div>
                    <div id="userListContainer" style="flex:1; overflow-y:auto;">
                        </div>
                </div>

                <div class="card" id="userEditor" style="overflow-y:auto; display:none;">
                    <div class="card-header">
                        <div>
                            <h2 id="ue-name" style="margin:0;">User Name</h2>
                            <small id="ue-uid" style="font-family:monospace; color:var(--accent);">UID</small>
                        </div>
                        <div class="badge badge-green" id="ue-email">email@test.com</div>
                    </div>

                    <div class="form-group">
                        <label>Main Fiat Balance ($)</label>
                        <div class="form-row">
                            <input type="number" id="ue-balance">
                            <button class="btn btn-primary" onclick="saveUserBalance()">Update</button>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

                    <div class="card-header" style="margin-bottom:10px;">
                        <h3><i class="fa-solid fa-coins"></i> Crypto Holdings</h3>
                        <button class="btn btn-sm" onclick="promptAddCoin()">+ Add Custom</button>
                    </div>
                    
                    <div id="holdingsContainer" class="grid-2" style="margin-top:15px; grid-template-columns: 1fr 1fr;"></div>
                    <button class="btn btn-primary" style="margin-top:15px; width:100%;" onclick="saveAllHoldings()">Save All Holdings</button>

                    <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">

                    <h3><i class="fa-solid fa-key"></i> Private Receiving Addresses</h3>
                    <div id="privAddrContainer" style="margin-top:15px;"></div>
                    <button class="btn btn-primary" style="margin-top:15px;" onclick="savePrivAddresses()">Save Addresses</button>
                </div>
                
                <div class="card" id="noUserSelected" style="display:flex; align-items:center; justify-content:center; color:var(--text-muted); min-height: 200px;">
                    <p>Select a user from the list to edit details.</p>
                </div>
            </div>
        </div>

        <div id="wallet" class="section">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-globe"></i> Global Market Data</h3></div>
                    <div class="form-group">
                        <label>Portfolio Change (%)</label>
                        <input type="number" id="market-change">
                    </div>
                    <div id="market-coins-list"></div>
                    <button class="btn btn-primary" style="margin-top:20px;" onclick="saveMarketData()">Update Market</button>
                </div>

                <div class="card">
                    <div class="card-header"><h3><i class="fa-solid fa-layer-group"></i> Global Staking Rules</h3></div>
                    
                    <div class="form-group">
                        <label>Display APY (Fallback text)</label>
                        <input type="number" id="rule-apy">
                    </div>

                    <hr class="section-divider">

                    <div style="margin-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:var(--accent);">ðŸ’° Reward Tiers (Logic)</label>
                            <small style="color:var(--text-muted);">Max $ / Reward %</small>
                        </div>
                        <div id="tier-list-container" class="dynamic-list-container">
                            </div>
                        <button class="btn btn-sm" onclick="addTierRow()">+ Add Tier</button>
                    </div>

                    <hr class="section-divider">

                    <div style="margin-bottom: 20px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="color:var(--accent);">ðŸ”“ Withdrawal Limits</label>
                            <small style="color:var(--text-muted);">Max $ / Req %</small>
                        </div>
                        <div id="limit-list-container" class="dynamic-list-container">
                            </div>
                        <button class="btn btn-sm" onclick="addLimitRow()">+ Add Limit</button>
                    </div>
                    
                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="saveStakingRules()">Save All Rules</button>
                </div>
            </div>
        </div>

        <div id="addressPool" class="section">
            <div class="card">
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <h3><i class="fa-solid fa-database"></i> Address Pool</h3>
                        <span class="badge badge-blue" id="pool-count">0 Loaded</span>
                    </div>
                </div>
                <div class="form-group">
                    <input type="text" id="poolSearch" placeholder="Search Wallet ID, Email or Address..." onkeyup="renderAddressPool()">
                </div>
                <div class="table-responsive" style="max-height: 600px;">
                    <table id="poolTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>ETH / BNB</th>
                                <th>BTC</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="poolTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="card" style="max-width:600px;">
                <div class="card-header"><h3><i class="fa-solid fa-bullhorn"></i> System Notice Popup</h3></div>
                <div class="form-group">
                    <label>Popup Title</label>
                    <input type="text" id="note-title">
                </div>
                <div class="form-group">
                    <label>Date Label</label>
                    <input type="text" id="note-date">
                </div>
                <div class="form-group">
                    <label>Version Label</label>
                    <input type="text" id="note-ver">
                </div>
                <div class="form-group">
                    <label>Message Body (supports \n for new lines)</label>
                    <textarea id="note-msg" rows="6" style="background:var(--bg-body); color:white; width:100%; padding:10px; border-radius:6px; border:1px solid var(--border);"></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveNotice()">Publish Notice</button>
            </div>
        </div>

    </div>
  </div>

  <div id="stakeModal" class="modal">
    <div class="modal-box">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <h3 id="modalTitle">Manage Stake</h3>
            <button class="btn btn-sm btn-danger" onclick="closeModal()">Close</button>
        </div>
        
        <input type="hidden" id="editUserId"><input type="hidden" id="editStakeId"><input type="hidden" id="inputWithdrawn">

        <label>User UID</label>
        <input type="text" id="inputUid" placeholder="Firebase User UID">

        <div class="form-row" style="margin-top:10px;">
            <div style="flex:1;">
                <label>Asset</label>
                <select id="inputCoin" onchange="updateModalPreview()">
                    <option value="USDT">USDT</option><option value="BTC">BTC</option>
                    <option value="ETH">ETH</option><option value="BNB">BNB</option>
                    <option value="TRX">TRX</option><option value="SOL">SOL</option>
                    <option value="XRP">XRP</option>
                </select>
            </div>
            <div style="flex:1;">
                <label>Locked Amount</label>
                <input type="number" id="inputAmount" step="0.0001" oninput="updateModalPreview()" placeholder="0.00">
            </div>
        </div>

        <div class="form-row" style="margin-top:10px;">
            <div style="flex:1;">
                <label>Daily Rate (0.01 = 1%)</label>
                <input type="number" id="inputRate" step="0.001" oninput="updateModalPreview()">
            </div>
            <div style="flex:1;">
                <label>Status</label>
                <select id="inputStatus" onchange="updateModalPreview()">
                    <option value="PENDING">PENDING</option>
                    <option value="ACTIVE">ACTIVE</option>
                    <option value="COMPLETED">COMPLETED</option>
                </select>
            </div>
        </div>

        <div class="form-row" style="margin-top:10px;">
            <div style="flex:1;">
                 <label>Duration (Days)</label>
                 <input type="number" id="inputDuration" value="30">
            </div>
            <div style="flex:1;">
                <label>Start Date</label>
                <input type="datetime-local" id="inputStartTime" oninput="updateModalPreview()">
            </div>
        </div>

        <div class="override-box">
            <label style="color:var(--success); margin:0;">Override "Available" Amount ($)</label>
            <input type="number" id="inputTargetAvailable" class="override-input" placeholder="Type to set exact available..." step="0.0001" oninput="handleAvailableOverride()">
            <div style="font-size:11px; color:var(--text-muted); margin-top:5px;">Adjusts the 'Withdrawn' field automatically.</div>
        </div>

        <div class="calc-preview">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>Est. Locked Value:</span>
                <span id="previewLockedUSD" style="color:white;">$0.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>Total Earned (calc):</span>
                <span id="previewEarned">0.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>Already Withdrawn:</span>
                <span id="previewWithdrawn" style="color:var(--text-muted)">0.00</span>
            </div>
            <div style="display:flex; justify-content:space-between; border-top:1px solid var(--border); padding-top:8px; margin-top:8px;">
                <span style="font-weight:bold;">Final Available:</span>
                <div style="text-align:right;">
                    <div id="previewAvailable" style="font-weight:bold; color:var(--success);">0.00</div>
                    <div id="previewAvailableUSD" style="font-size:11px; color:var(--text-muted);">â‰ˆ $0.00</div>
                </div>
            </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveStakeData()">Save Changes</button>
        </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script>
    // --- 1. FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyByvett5gGhga0jx2pBChmg41IKaTvbY24",
      authDomain: "bustrack-e4f8f.firebaseapp.com",
      databaseURL: "https://bustrack-e4f8f-default-rtdb.firebaseio.com",
      projectId: "bustrack-e4f8f",
      storageBucket: "bustrack-e4f8f.firebasestorage.app",
      messagingSenderId: "544737954134",
      appId: "1:544737954134:web:91a197cc88d0a67c43eef7"
    };

    let db;
    let localData = {}; 
    let isOffline = false;
    let currentUserUid = null;
    let currentCalculatedEarned = 0;
    
    // Crypto Prices
    let coinPrices = { 'USDT': 1.00, 'BTC': 0, 'ETH': 0, 'BNB': 0, 'TRX': 0, 'SOL': 0, 'XRP': 0 };
    const STANDARD_COINS = ['BTC', 'ETH', 'BNB', 'SOL', 'TRX', 'USDT', 'XRP', 'ADA', 'DOGE', 'LTC', 'MATIC', 'DOT'];

    window.addEventListener('load', initApp);

    function initApp() {
        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            fetchCryptoPrices(); // Get prices
            setupRealtimeListeners();
        } catch (e) {
            console.error("Firebase Init Error:", e);
            setOfflineMode();
        }
    }

    // --- COIN GECKO API ---
    async function fetchCryptoPrices() {
        try {
            const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,binancecoin,tron,solana,ripple,tether&vs_currencies=usd');
            const data = await response.json();
            if(data.bitcoin) coinPrices['BTC'] = data.bitcoin.usd;
            if(data.ethereum) coinPrices['ETH'] = data.ethereum.usd;
            if(data.binancecoin) coinPrices['BNB'] = data.binancecoin.usd;
            if(data.tron) coinPrices['TRX'] = data.tron.usd;
            if(data.solana) coinPrices['SOL'] = data.solana.usd;
            if(data.ripple) coinPrices['XRP'] = data.ripple.usd;
            if(data.tether) coinPrices['USDT'] = data.tether.usd;
            refreshUI(); 
        } catch (error) { console.log("Price fetch failed, using defaults"); }
    }

    // --- MOBILE UI FUNCTIONS ---
    function toggleSidebar() {
        const sb = document.getElementById('sidebar');
        const bd = document.getElementById('backdrop');
        sb.classList.toggle('active');
        bd.classList.toggle('active');
    }

    function setupRealtimeListeners() {
        const connectedRef = db.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            if (snap.val() === true) setOnlineMode();
        });

        db.ref('/').on('value', (snapshot) => {
            localData = snapshot.val() || {};
            refreshUI();
            document.getElementById('loadingOverlay').style.display = 'none';
        }, (error) => {
            console.error("Read Error:", error);
            notify("Permission Denied or Network Error. Switch to JSON Mode.", "error");
            setOfflineMode();
            document.getElementById('loadingOverlay').style.display = 'none';
        });
    }

    function setOnlineMode() {
        isOffline = false;
        const statusEl = document.getElementById('connStatus');
        statusEl.className = 'connection-status status-live';
        document.getElementById('connText').textContent = "Live Database";
    }

    function setOfflineMode() {
        isOffline = true;
        const statusEl = document.getElementById('connStatus');
        statusEl.className = 'connection-status status-offline';
        document.getElementById('connText').textContent = "Offline / JSON Mode";
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    // --- 2. JSON IMPORT/EXPORT ---
    function handleJsonUpload(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                localData = JSON.parse(e.target.result);
                refreshUI();
                setOfflineMode();
                notify("JSON Data Loaded Successfully", "success");
            } catch (err) {
                notify("Invalid JSON File", "error");
            }
        };
        reader.readAsText(file);
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(localData, null, 2));
        const anchor = document.createElement('a');
        anchor.setAttribute("href", dataStr);
        anchor.setAttribute("download", "firebase_backup_" + Date.now() + ".json");
        document.body.appendChild(anchor);
        anchor.click();
        anchor.remove();
    }

    // --- 3. UI RENDERING ---
    function refreshUI() {
        renderDashboard();
        renderStakingSection();
        renderUserList();
        if (currentUserUid) loadUser(currentUserUid);
        renderWalletMarket();
        renderAddressPool();
        renderSettings();
    }

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('pageTitle').innerText = btn.innerText.trim();
        
        // Auto close sidebar on mobile selection
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('backdrop').classList.remove('active');
    }

    function renderDashboard() {
        const userCount = localData.users ? Object.keys(localData.users).length : 0;
        const poolCount = localData.addressPool ? Object.keys(localData.addressPool).length : 0;
        const trend = localData.walletData ? localData.walletData.portfolioChange : 0;

        document.getElementById('stat-users').innerText = userCount;
        document.getElementById('stat-pool').innerText = poolCount;
        document.getElementById('stat-change').innerText = trend + "%";
    }

    // --- NEW STAKING LOGIC ---
    function renderStakingSection() {
        const tbody = document.getElementById('stakesTableBody');
        const search = document.getElementById('stakeSearch').value.toLowerCase();
        tbody.innerHTML = '';
        
        // Global Cycle
        const globalPeriodMs = localData.globalStakingRules ? (localData.globalStakingRules.rewardPeriodMs || 86400000) : 86400000;
        document.getElementById('globalPeriodMs').value = globalPeriodMs;
        const min = globalPeriodMs/60000;
        document.getElementById('stake-cycle').innerText = min >= 60 ? (min/60).toFixed(1)+" Hrs" : min+" Mins";

        // Flatten Stakes
        let allStakes = [];
        if(localData.userStakes) {
            for(const uid in localData.userStakes) {
                for(const sid in localData.userStakes[uid]) {
                    allStakes.push({ uid, ...localData.userStakes[uid][sid] });
                }
            }
        }

        const filtered = allStakes.filter(s => s.uid.toLowerCase().includes(search) || s.coin.toLowerCase().includes(search));
        filtered.sort((a,b) => (b.startTime||0) - (a.startTime||0));

        let totalTVL = 0;
        if(filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">No stakes found.</td></tr>';
            document.getElementById('stake-tvl').innerText = "$0.00";
            return;
        }

        filtered.forEach(s => {
            // Calc Logic
            let earned = 0, available = 0;
            if(s.status !== 'PENDING') {
                const now = Date.now();
                const start = s.startTime || now;
                const periods = Math.floor((now - start) / globalPeriodMs);
                earned = periods > 0 ? (parseFloat(s.amount) * parseFloat(s.dailyRate) * periods) : 0;
                const claimed = parseFloat(s.rewardsWithdrawn || 0);
                available = earned - claimed;
            }
            
            // Value Logic
            const price = coinPrices[s.coin] || 0;
            const lockedUSD = (parseFloat(s.amount) * price);
            const earnedUSD = (earned * price);
            const availUSD = (available * price);
            
            if(s.status === 'ACTIVE') totalTVL += lockedUSD;

            const badge = s.status === 'ACTIVE' ? 'badge-green' : (s.status === 'PENDING' ? 'badge-warn' : 'badge-blue');

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="font-weight:600;">${s.uid.substring(0,6)}...</div>
                    <div style="font-size:10px; color:var(--text-muted);">${s.uid}</div>
                </td>
                <td>
                    <span class="coin-val">${parseFloat(s.amount).toFixed(4)} ${s.coin}</span>
                    <span class="usd-val dim">â‰ˆ $${lockedUSD.toFixed(2)}</span>
                </td>
                <td>
                    <span class="coin-val" style="color:var(--text-muted)">${earned.toFixed(4)}</span>
                    <span class="usd-val dim">$${earnedUSD.toFixed(2)}</span>
                </td>
                <td>
                    <span class="coin-val" style="color:var(--success)">${available.toFixed(4)}</span>
                    <span class="usd-val">$${availUSD.toFixed(2)}</span>
                </td>
                <td><span class="badge ${badge}">${s.status}</span></td>
                <td>
                    <button class="btn btn-sm" onclick='openEditModal(${JSON.stringify(s)})'>Edit</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('stake-tvl').innerText = "$" + totalTVL.toLocaleString(undefined, {minimumFractionDigits: 2});
    }

    function promptCycleUpdate() {
        const ms = prompt("Enter reward cycle in milliseconds (e.g., 86400000 for 24h):", document.getElementById('globalPeriodMs').value);
        if(ms) {
            updateDB('globalStakingRules/rewardPeriodMs', parseInt(ms));
        }
    }

    // --- MODAL & STAKE EDIT LOGIC ---
    function openEditModal(s) {
        document.getElementById('modalTitle').innerText = "Edit Stake";
        document.getElementById('editUserId').value = s.uid;
        document.getElementById('editStakeId').value = s.id;
        
        document.getElementById('inputUid').value = s.uid;
        document.getElementById('inputUid').disabled = true;

        document.getElementById('inputCoin').value = s.coin;
        document.getElementById('inputAmount').value = s.amount;
        document.getElementById('inputRate').value = s.dailyRate;
        document.getElementById('inputStatus').value = s.status;
        document.getElementById('inputDuration').value = s.durationDays;
        document.getElementById('inputWithdrawn').value = s.rewardsWithdrawn || 0;

        if(s.startTime) {
            const date = new Date(s.startTime);
            const iso = new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('inputStartTime').value = iso;
        } else {
            document.getElementById('inputStartTime').value = "";
        }
        document.getElementById('inputTargetAvailable').value = ""; // Reset override input

        updateModalPreview(true);
        document.getElementById('stakeModal').classList.add('show');
    }

    function openAddModal() {
        document.getElementById('modalTitle').innerText = "Create New Stake";
        document.getElementById('editUserId').value = "";
        document.getElementById('editStakeId').value = "";
        document.getElementById('inputUid').value = "";
        document.getElementById('inputUid').disabled = false;
        
        document.getElementById('inputAmount').value = "";
        document.getElementById('inputRate').value = "0.01";
        document.getElementById('inputStatus').value = "ACTIVE";
        document.getElementById('inputWithdrawn').value = "0";
        
        const now = new Date();
        const iso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
        document.getElementById('inputStartTime').value = iso;

        updateModalPreview(true);
        document.getElementById('stakeModal').classList.add('show');
    }

    function updateModalPreview(fromOverride = true) {
        const coin = document.getElementById('inputCoin').value;
        const amount = parseFloat(document.getElementById('inputAmount').value) || 0;
        const rate = parseFloat(document.getElementById('inputRate').value) || 0;
        const withdrawn = parseFloat(document.getElementById('inputWithdrawn').value) || 0;
        const timeVal = document.getElementById('inputStartTime').value;
        
        const globalPeriodMs = parseInt(document.getElementById('globalPeriodMs').value) || 86400000;

        let earned = 0;
        if(timeVal) {
            const start = new Date(timeVal).getTime();
            const periods = Math.floor((Date.now() - start) / globalPeriodMs);
            earned = periods > 0 ? (amount * rate * periods) : 0;
        }
        currentCalculatedEarned = earned;
        const available = earned - withdrawn;

        const price = coinPrices[coin] || 0;
        const lockedUSD = amount * price;
        const availUSD = available * price;

        document.getElementById('previewEarned').innerText = earned.toFixed(6);
        document.getElementById('previewWithdrawn').innerText = withdrawn.toFixed(6);
        document.getElementById('previewAvailable').innerText = available.toFixed(6);
        
        document.getElementById('previewLockedUSD').innerText = '$' + lockedUSD.toLocaleString(undefined, {minimumFractionDigits: 2});
        document.getElementById('previewAvailableUSD').innerText = '$' + availUSD.toLocaleString(undefined, {minimumFractionDigits: 2});

        if(fromOverride) {
            // If just viewing, show Available converted to USD in override box? 
            // Better: Show nothing in placeholder
        }
    }

    function handleAvailableOverride() {
        // User wants to force available to be $X (or Coin X)
        // Let's assume input is in Coins for now based on logic, but UI says $?
        // Let's assume input is COINS to match backend logic, simpler.
        // Actually, prompt asked for $ value. But overrides work best on Coin amount. 
        // I will implement override based on COIN amount (matches logic) but label clearly.
        // Re-labeling UI to "Amount" to be safe.
        
        const target = parseFloat(document.getElementById('inputTargetAvailable').value);
        if(isNaN(target)) return;
        
        // Withdrawn = Earned - Available
        let newWithdrawn = currentCalculatedEarned - target;
        document.getElementById('inputWithdrawn').value = newWithdrawn.toFixed(6);
        updateModalPreview(false);
    }

    function saveStakeData() {
        const uid = document.getElementById('inputUid').value.trim();
        const sid = document.getElementById('editStakeId').value;
        
        if(!uid) return notify("User UID is required.", "error");

        const dateVal = document.getElementById('inputStartTime').value;
        const startTime = dateVal ? new Date(dateVal).getTime() : Date.now();

        const payload = {
            coin: document.getElementById('inputCoin').value,
            amount: parseFloat(document.getElementById('inputAmount').value).toFixed(4),
            dailyRate: parseFloat(document.getElementById('inputRate').value),
            status: document.getElementById('inputStatus').value,
            durationDays: parseInt(document.getElementById('inputDuration').value),
            rewardsWithdrawn: parseFloat(document.getElementById('inputWithdrawn').value) || 0,
            startTime: startTime
        };

        if(sid) {
            updateDB(`userStakes/${uid}/${sid}`, payload);
        } else {
            const newRef = db.ref(`userStakes/${uid}`).push();
            payload.id = newRef.key;
            newRef.set(payload).then(()=>{
                notify("Stake Created", "success");
                closeModal();
            });
        }
        if(sid) closeModal();
    }
    
    function closeModal() { document.getElementById('stakeModal').classList.remove('show'); }

    // --- 4. USER MANAGER ---
    function renderUserList() {
        const listEl = document.getElementById('userListContainer');
        const filter = document.getElementById('userSearch').value.toLowerCase();
        listEl.innerHTML = '';

        if (!localData.users) return;

        Object.entries(localData.users).forEach(([uid, user]) => {
            const searchStr = (user.email + user.name + uid).toLowerCase();
            if (filter && !searchStr.includes(filter)) return;

            const div = document.createElement('div');
            div.className = `user-list-item ${uid === currentUserUid ? 'selected' : ''}`;
            div.onclick = () => loadUser(uid);
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <span style="font-weight:600; font-size:13px;">${user.name || 'No Name'}</span>
                    <span class="badge badge-gray">${uid.substring(0,5)}...</span>
                </div>
                <div style="font-size:12px; color:var(--text-muted); margin-top:2px;">${user.email}</div>
            `;
            listEl.appendChild(div);
        });
    }

    function loadUser(uid) {
        currentUserUid = uid;
        document.getElementById('noUserSelected').style.display = 'none';
        document.getElementById('userEditor').style.display = 'block';
        renderUserList(); 

        const user = localData.users[uid];
        document.getElementById('ue-name').innerText = user.name || 'Unknown';
        document.getElementById('ue-uid').innerText = uid;
        document.getElementById('ue-email').innerText = user.email;
        document.getElementById('ue-balance').value = user.balance || 0;

        renderUserHoldings(uid);

        const privEl = document.getElementById('privAddrContainer');
        privEl.innerHTML = '';
        const privData = (localData.privilegesecdata && localData.privilegesecdata[uid]) ? localData.privilegesecdata[uid] : {};
        ['btc', 'eth', 'bnb', 'sol', 'trx', 'usdt', 'xrp'].forEach(c => {
            const div = document.createElement('div');
            div.className = 'form-group';
            div.innerHTML = `
                <label>${c.toUpperCase()} Address</label>
                <input type="text" class="priv-input" data-coin="${c}" value="${privData[c] || ''}">
            `;
            privEl.appendChild(div);
        });
    }

    function renderUserHoldings(uid) {
        const holdingsEl = document.getElementById('holdingsContainer');
        holdingsEl.innerHTML = '';
        
        const userHoldings = (localData.userHoldings && localData.userHoldings[uid]) ? localData.userHoldings[uid] : {};
        const globalCoins = localData.globalcoindata ? Object.keys(localData.globalcoindata) : [];
        const existingUserCoins = Object.keys(userHoldings);
        
        const mergedCoins = [...new Set([...STANDARD_COINS, ...globalCoins, ...existingUserCoins])].sort();

        mergedCoins.forEach(coin => {
            const h = userHoldings[coin] || { hold: 0 };
            const hasBal = h.hold > 0;
            
            const div = document.createElement('div');
            div.className = `holding-item ${hasBal ? 'has-balance' : ''}`;
            div.innerHTML = `
                <div class="holding-label">${coin}</div>
                <input type="number" class="holding-input" data-coin="${coin}" value="${h.hold || 0}" style="width:100px;">
            `;
            holdingsEl.appendChild(div);
        });
    }

    function promptAddCoin() {
        if(!currentUserUid) return notify("Select a user first", "error");
        const coinSymbol = prompt("Enter Coin Symbol (e.g. SHIB):");
        if(coinSymbol) {
            const symbol = coinSymbol.toUpperCase();
            if(!localData.userHoldings) localData.userHoldings = {};
            if(!localData.userHoldings[currentUserUid]) localData.userHoldings[currentUserUid] = {};
            
            if(!localData.userHoldings[currentUserUid][symbol]) {
                localData.userHoldings[currentUserUid][symbol] = { hold: 0 };
            }
            renderUserHoldings(currentUserUid);
            notify(`Added ${symbol}. Set balance and click Save.`, "success");
        }
    }

    function saveUserBalance() {
        if (!currentUserUid) return;
        const val = parseFloat(document.getElementById('ue-balance').value);
        updateDB(`users/${currentUserUid}/balance`, val);
    }

    function saveAllHoldings() {
        if (!currentUserUid) return;
        const inputs = document.querySelectorAll('.holding-input');
        const updates = {};
        inputs.forEach(inp => {
            const coin = inp.dataset.coin;
            const val = parseFloat(inp.value);
            let name = coin;
            if(localData.globalcoindata && localData.globalcoindata[coin]) name = localData.globalcoindata[coin].name;
            
            if(val > 0 || localData.userHoldings?.[currentUserUid]?.[coin]) {
                 updates[`userHoldings/${currentUserUid}/${coin}`] = { hold: val, name: name };
            }
        });
        updateDBRoot(updates);
    }

    function savePrivAddresses() {
        if (!currentUserUid) return;
        const inputs = document.querySelectorAll('.priv-input');
        const updates = {};
        inputs.forEach(inp => {
            updates[`privilegesecdata/${currentUserUid}/${inp.dataset.coin}`] = inp.value.trim();
        });
        updateDBRoot(updates);
    }

    // --- 5. MARKET & RULES ---
    function renderWalletMarket() {
        if (localData.walletData) {
            document.getElementById('market-change').value = localData.walletData.portfolioChange || 0;
            const list = document.getElementById('market-coins-list');
            list.innerHTML = '';
            
            const coins = localData.walletData.coinData || {};
            Object.entries(coins).forEach(([sym, data]) => {
                const div = document.createElement('div');
                div.style.marginBottom = '10px';
                div.innerHTML = `
                    <label style="color:var(--accent); font-weight:bold;">${sym}</label>
                    <div class="form-row">
                        <input type="number" class="market-inp" data-sym="${sym}" data-field="price" value="${data.price}" placeholder="Price">
                        <input type="number" class="market-inp" data-sym="${sym}" data-field="chg" value="${data.chg}" placeholder="Change %">
                    </div>
                `;
                list.appendChild(div);
            });
        }

        if (localData.globalStakingRules) {
            document.getElementById('rule-apy').value = localData.globalStakingRules.estAPY || 0;
            renderStakingRows('tier-list-container', localData.globalStakingRules.tiers, 'tier');
            renderStakingRows('limit-list-container', localData.globalStakingRules.withdrawLimits, 'limit');
        }
    }

    function renderStakingRows(containerId, dataArray, type) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!dataArray || !Array.isArray(dataArray)) return;

        dataArray.forEach(item => {
            const div = document.createElement('div');
            div.className = `dynamic-row ${type}-row`;
            
            let val1 = item.max; 
            let val2 = type === 'tier' ? (item.rate * 100).toFixed(2) : (item.percent * 100).toFixed(0);

            div.innerHTML = `
                <input type="number" class="${type}-max" value="${val1}" placeholder="Max $">
                <input type="number" class="${type}-val" value="${val2}" placeholder="${type === 'tier' ? 'Daily %' : 'Req %'}">
                <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>
            `;
            container.appendChild(div);
        });
    }

    function addTierRow() {
        const container = document.getElementById('tier-list-container');
        const div = document.createElement('div');
        div.className = 'dynamic-row tier-row';
        div.innerHTML = `
            <input type="number" class="tier-max" placeholder="Max $" value="1000">
            <input type="number" class="tier-val" placeholder="Reward %" value="1.0">
            <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>
        `;
        container.appendChild(div);
    }

    function addLimitRow() {
        const container = document.getElementById('limit-list-container');
        const div = document.createElement('div');
        div.className = 'dynamic-row limit-row';
        div.innerHTML = `
            <input type="number" class="limit-max" placeholder="Max $" value="500">
            <input type="number" class="limit-val" placeholder="Req %" value="10">
            <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()"><i class="fa-solid fa-trash"></i></button>
        `;
        container.appendChild(div);
    }

    function saveMarketData() {
        const change = parseFloat(document.getElementById('market-change').value);
        const inputs = document.querySelectorAll('.market-inp');
        const updates = {};
        
        updates['walletData/portfolioChange'] = change;
        inputs.forEach(inp => {
            updates[`walletData/coinData/${inp.dataset.sym}/${inp.dataset.field}`] = parseFloat(inp.value);
        });
        updateDBRoot(updates);
    }

    function saveStakingRules() {
        const estAPY = parseFloat(document.getElementById('rule-apy').value);
        
        const tierRows = document.querySelectorAll('.tier-row');
        let newTiers = [];
        tierRows.forEach(row => {
            const max = parseFloat(row.querySelector('.tier-max').value);
            const rate = parseFloat(row.querySelector('.tier-val').value);
            if(!isNaN(max) && !isNaN(rate)) {
                newTiers.push({ max: max, rate: rate / 100 });
            }
        });
        newTiers.sort((a,b) => a.max - b.max);

        const limitRows = document.querySelectorAll('.limit-row');
        let newLimits = [];
        limitRows.forEach(row => {
            const max = parseFloat(row.querySelector('.limit-max').value);
            const pct = parseFloat(row.querySelector('.limit-val').value);
            if(!isNaN(max) && !isNaN(pct)) {
                newLimits.push({ max: max, percent: pct / 100 });
            }
        });
        newLimits.sort((a,b) => a.max - b.max);

        const updates = {};
        updates['globalStakingRules/estAPY'] = estAPY;
        updates['globalStakingRules/tiers'] = newTiers;
        updates['globalStakingRules/withdrawLimits'] = newLimits;

        updateDBRoot(updates);
    }

    // --- 6. ADDRESS POOL ---
    function renderAddressPool() {
        const tbody = document.getElementById('poolTableBody');
        const filter = document.getElementById('poolSearch').value.toLowerCase();
        
        tbody.innerHTML = '';
        if (!localData.addressPool) return;

        const pool = localData.addressPool;
        document.getElementById('pool-count').innerText = Object.keys(pool).length + " Loaded";

        Object.entries(pool).forEach(([id, data]) => {
            let assignedDisplay = "-";
            if (data.assigned && data.assignedToUid) {
                if (localData.users && localData.users[data.assignedToUid]) {
                    assignedDisplay = localData.users[data.assignedToUid].email;
                } else {
                    assignedDisplay = data.assignedToUid; 
                }
            }

            const searchString = `${id} ${assignedDisplay} ${data.eth || ''} ${data.btc || ''}`.toLowerCase();
            if (filter && !searchString.includes(filter)) return;

            const tr = document.createElement('tr');
            const statusBadge = data.assigned 
                ? `<span class="badge badge-blue">Assigned</span>` 
                : `<span class="badge badge-green">Free</span>`;
                
            const assignedClass = data.assigned ? "color:var(--accent); font-weight:600;" : "color:var(--text-muted);";

            tr.innerHTML = `
                <td><strong>${id}</strong></td>
                <td>${statusBadge}</td>
                <td style="${assignedClass}">${assignedDisplay}</td>
                <td style="font-family:monospace; font-size:12px;">${data.eth ? data.eth.substring(0,10)+'...' : ''}</td>
                <td style="font-family:monospace; font-size:12px;">${data.btc ? data.btc.substring(0,10)+'...' : ''}</td>
                <td><button class="btn" style="padding:4px 8px; font-size:11px;" onclick="togglePool('${id}', ${data.assigned})">Toggle</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function togglePool(id, currentStatus) {
        updateDB(`addressPool/${id}/assigned`, !currentStatus);
    }

    // --- 7. SETTINGS ---
    function renderSettings() {
        if(localData.system_notice) {
            const n = localData.system_notice;
            document.getElementById('note-title').value = n.title || '';
            document.getElementById('note-date').value = n.date || '';
            document.getElementById('note-ver').value = n.version || '';
            document.getElementById('note-msg').value = n.message || '';
        }
    }

    function saveNotice() {
        const updates = {
            title: document.getElementById('note-title').value,
            date: document.getElementById('note-date').value,
            version: document.getElementById('note-ver').value,
            message: document.getElementById('note-msg').value,
            isEnabled: true
        };
        updateDB('system_notice', updates);
    }

    // --- HELPER: DATABASE UPDATE ---
    function updateDB(path, value) {
        if (isOffline) {
            notify("Offline Mode: Export JSON to save file.", "success");
        } else {
            db.ref(path).set(value).then(() => notify("Updated Successfully", "success"))
            .catch(e => notify("Update Failed: " + e.message, "error"));
        }
    }

    function updateDBRoot(updates) {
        if (isOffline) {
            notify("Offline Mode: Export JSON.", "success");
        } else {
            db.ref().update(updates).then(() => notify("Batch Update Successful", "success"))
            .catch(e => notify("Batch Update Failed: " + e.message, "error"));
        }
    }

    function notify(msg, type) {
        let color = type === "error" ? "#ef4444" : "#22c55e";
        Toastify({
            text: msg,
            duration: 3000,
            gravity: "bottom",
            position: "right",
            style: { background: color, borderRadius: "8px", fontSize:"13px" }
        }).showToast();
    }
  </script>
</body>
</html>
